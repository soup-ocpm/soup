<div class="master">
  <!--Graph visualization-->
  <div
    class="master-graph"
    [ngClass]="{
      small: this.sidebarService.isSidebarOpen('master-sidebar'),
      'small-two': this.sidebarService.isSidebarOpen('search-sidebar')
    }">
    <div id="myGraphContainer">
      <svg #graphSvg></svg>

      <div class="graph-spinner">
        <sp-spinner *ngIf="this.isLoadingNewNodes"></sp-spinner>
      </div>
    </div>
  </div>

  <!--Right Action buttons-->
  <div class="right-actions">
    <i
      matTooltip="Menu"
      class="bi bi-card-list"
      style="margin-right: 7px"
      (click)="this.openMasterSidebar()"></i>
    <i
      matTooltip="Search"
      class="bi bi-search"
      style="margin-top: 10px; margin-right: 7px"
      (click)="this.openSearchSidebar()"></i>
  </div>

  <!--Left Action buttons-->
  <div
    class="left-actions"
    *ngIf="
      !this.sidebarService.isSidebarOpen('master-sidebar') &&
      !this.sidebarService.isSidebarOpen('search-sidebar') &&
      this.supportService.graphType != 3
    ">
    <i
      matTooltip="Leave"
      class="bi bi-arrow-left-square"
      (click)="this.leavePage()"></i>
  </div>

  <!--Card for selected node-->
  <div
    *ngIf="this.isShowCardProperties"
    class="node-properties-card">
    <h4>Node Properties</h4>
    <div
      *ngFor="let property of this.propertiesSelectedNode"
      class="property-item">
      <strong>{{ property[0] }}:</strong>
      <span>{{ property[1] || 'N/A' }}</span>
    </div>
    <button
      class="close-btn"
      (click)="this.closeNodeSearched()">
      Close
    </button>
  </div>

  <!--List of the sidebar-->
  <s-sidebar
    *ngFor="let sidebarId of this.sidebarIds"
    [sidebarId]="sidebarId"></s-sidebar>

  <!--Menu Sidebar-->
  <ng-template #masterSidebarTemplate>
    <p>A list of operations available for this section</p>

    <!-- Operations Section -->
    <div class="operation-container">
      <app-side-operation
        *ngFor="let operation of this.operations"
        [title]="operation.title"
        [description]="operation.description"
        [icon]="operation.icon"
        [action]="operation.action"
        [loading]="operation.loading"
        (operationSelected)="this.onOperationSelected(operation)"></app-side-operation>
    </div>
  </ng-template>

  <!--Search Sidebar-->
  <ng-template #searchSidebarTemplate>
    <p>Search node or links inside your graph</p>

    <!--Input-->
    <div class="search-dataset">
      <input
        class="form-control form-control-sm"
        style="margin-top: 10px"
        type="text"
        placeholder="Receive Order..."
        [(ngModel)]="searchTerm"
        (input)="this.searchData()" />
    </div>

    <div style="height: 20px"></div>
    <sp-divider></sp-divider>

    <!--Tabber-->
    <mat-tab-group
      #tabber
      (selectedTabChange)="this.onTabChange($event)">
      <!--Node tab-->
      <mat-tab
        label="Nodes"
        class="tabber">
        <div
          class="master-search"
          (scroll)="onScrollNodes()"
          style="margin-top: 15px"
          #scrollNodeContainer>
          <div
            class="search-term"
            *ngFor="let item of displayedNodes">
            <div class="item-details">
              <p>
                <strong>Activity:</strong>
                <span style="color: var(--primary-color)">{{ item['ActivityName'] }}</span>
              </p>
              <p>
                <strong>Event id:</strong>
                {{ item['Event_Id'] }}
              </p>
              <p *ngIf="this.supportService.graphType == 1">
                <strong>Timestamp:</strong>
                {{ item['Timestamp'] }}
              </p>
            </div>
            <div class="icon-section">
              <i
                class="bi bi-arrow-right-circle"
                (click)="this.selectNodeSearched(item)"></i>
            </div>
          </div>

          <!-- Loading -->
          <div
            class="loading-indicator"
            *ngIf="isLoading">
            <p>Loading more data...</p>
          </div>
        </div>
      </mat-tab>

      <!--Edges tab-->
      <mat-tab
        label="Links"
        class="tabber">
        <div
          class="master-search"
          (scroll)="this.onScrollEdges()"
          style="margin-top: 15px"
          #scrollEdgesContainer>
          <div
            *ngFor="let item of displayedEdges"
            class="search-term"
            (mouseenter)="this.hoverEdge(item)"
            (mouseleave)="this.leaveHoverEdge(item)">
            <div class="item-details">
              <h5 style="color: var(--primary-color)">{{ item['label'] }}</h5>
              <p>
                <strong>From:</strong>
                {{ this.getNodeName(item.source.id) }} [{{ item.source.id }}]
              </p>
              <p>
                <strong>To:</strong>
                {{ this.getNodeName(item.target.id) }} [{{ item.target.id }}]
              </p>
            </div>
          </div>

          <!-- Loading-->
          <div
            class="loading-indicator"
            *ngIf="isLoading">
            <p>Loading more data...</p>
          </div>
        </div>
      </mat-tab>
    </mat-tab-group>
  </ng-template>

  <!--Frequency Sidebar-->
  <ng-template #frequencySidebarTemplate>
    <p style="margin-top: 15px; font-size: 16px">Here are the calculated frequencies for the activities</p>

    <sp-divider></sp-divider>

    <!--List of the frequencies-->
    <ul class="frequency-list">
      <li
        *ngFor="let item of this.frequencyResults"
        class="frequency-card">
        <div class="card-content">
          <span class="activity-name">{{ item.activity }}</span>
          <span class="activity-frequency">{{ item.frequency | number: '1.0-0' }} occurrences</span>
        </div>
      </li>
    </ul>
  </ng-template>

  <!--Variation Sidebar-->
  <ng-template #variationSidebarTemplate>
    <div class="activity-summary">
      <!-- Iterate over all variationResults to show the details for each one -->
      <p>
        Sequence of maximum
        <strong>5</strong>
        consecutive steps based on the complete Dataset
      </p>
      <div
        *ngFor="let variation of this.variationResults"
        class="details-summary">
        <p>
          <strong>Involved Activities:</strong>
          The combination of events that produced this case includes
          <strong>{{ variation.activities.length }}</strong>
          activities, some of which are repeated.
        </p>

        <p>
          <strong>Distinct Activities:</strong>
          There are
          <strong>{{ variation.distinctActivities.length }}</strong>
          distinct activities in your dataset. Some events are repeated within the cycle.
        </p>

        <p>
          <strong>Average Duration:</strong>
          The average duration of the event cycle is
          <strong>{{ variation.avgDuration }}</strong>
          seconds (about
          <strong>{{ this.convertVariationTimeDuraiton(variation.avgDuration) }}</strong>
          ).
        </p>

        <p>
          <strong>Frequency:</strong>
          This specific case of activities has been observed
          <strong>{{ variation.frequency }}</strong>
          times.
        </p>
      </div>
    </div>

    <!-- List of distinct activities for each variation -->
    <div *ngFor="let variation of this.variationResults">
      <!-- Bold text for the section heading -->
      <p style="font-weight: bold; margin-bottom: 8px">List of distinct activities</p>

      <ul>
        <!-- List of distinct activities -->
        <li
          *ngFor="let activity of variation.distinctActivities"
          class="activity-item">
          <div class="activity-info">
            <span class="activity-name">{{ activity }}</span>
          </div>
        </li>
      </ul>
    </div>
  </ng-template>

  <!--Json Sidebar-->
  <ng-template #jsonSidebarTemplate>
    <p style="margin-top: 15px">This operation allows to download specific JSON of your Dataset.</p>

    <p style="color: #c4a805; margin-bottom: 5px">Note:</p>
    <p style="margin-top: 0; margin-bottom: 10px">
      The time taken depends on the amount of data generated by the Dataset. This operation may take a few minutes
    </p>

    <sp-divider></sp-divider>

    <li
      *ngFor="let object of this.jsonList"
      class="list-group-item">
      <span style="margin-top: 5px">{{ object.name }}</span>

      <div class="group">
        <mat-slide-toggle
          style="margin-top: 3px"
          [(ngModel)]="object.isSelected"
          (change)="this.selectionJson(object)"
          color="primary"></mat-slide-toggle>
      </div>
    </li>
  </ng-template>

  <!--Manage graph Sidebar-->
  <ng-template #manageGraphSidebarTemplate>
    <p>A list of operations available for this section</p>

    <!--Node showed slider-->
    <div *ngIf="this.supportService.graphType != 3">
      <div style="margin-top: 35px"></div>
      <div class="double-flex">
        <h5>Data displayed</h5>
        <mat-icon
          *ngIf="this.totalUniqueNodeShowed > 300"
          [matTooltip]="'More than 300 nodes may cause rendering delays'">
          warning
        </mat-icon>
      </div>
      <div style="width: 100%">
        <mat-slider
          class="example-margin"
          [max]="this.currentDataset!.eventNodes"
          [min]="2"
          [step]="1"
          [discrete]="true"
          [showTickMarks]="true">
          <input
            matSliderThumb
            [(ngModel)]="this.totalUniqueNodeShowed"
            (ngModelChange)="this.onSliderValueChanged($event)"
            #slider />
        </mat-slider>
      </div>
    </div>

    <!--Node view-->
    <div>
      <div style="margin-top: 35px">
        <div style="margin-top: 35px"></div>
        <div class="double-flex">
          <h5>Nodes</h5>
          <mat-icon [matTooltip]="'The size of the circle does not correspond to node weight'">warning</mat-icon>
        </div>
        <p>Change the view of your nodes</p>
        <div style="margin-top: 15px"></div>
        <mat-radio-group
          aria-labelledby="example-radio-group-label"
          class="example-radio-group"
          [(ngModel)]="nodeViewType"
          (ngModelChange)="this.onChangeNodeView($event)">
          @for (type of allNodesViewType; track type) {
            <mat-radio-button
              class="example-radio-button"
              color="primary"
              [value]="type">
              {{ type }}
            </mat-radio-button>
          }
        </mat-radio-group>

        <!--Edges view-->
        <div style="margin-top: 35px"></div>
        <div class="double-flex">
          <h5>Edges</h5>
        </div>

        <p>Select the relationships you want to see</p>

        <div *ngFor="let rel of this.allRelationships">
          <mat-checkbox
            color="primary"
            [ngModel]="rel.selected"
            (ngModelChange)="this.onChangeRelationshipsView(rel, $event)">
            {{ rel.name }}
          </mat-checkbox>
        </div>
      </div>
    </div>
  </ng-template>
</div>
